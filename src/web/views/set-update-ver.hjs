<!DOCTYPE html>
<html lang="en">
  {{> header}}
  <body>
    {{> page_header}}
    <div id="body-container">
      <div id="body-content">
        {{> nav}}
        <section class="page container">
          <form class="form-horizontal">
            <div class="container">
              <div class="row">
                <div class="span16">
                  <fieldset>
                    <legend>设备备案版本修改（设备需要启用“自动同步备案版本”选项）</legend><br/>
                    <span style="font-size: 18px">按型号批量修改</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <select id="session-models" class="span2">
                      <option value="all">--请选择型号-- </option>
                    </select>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    修改版本: <input type="text" name="ver" value=""/>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id="set-batch-update" class="btn btn-primary">提交</button>
                  </fieldset>
                </div>
              </div>            
              <br/>
              <div class="row">
                <div class="span16">
                  <div class="box pattern pattern-sandstone">
                    <div class="box-header">
                      <i class="icon-table"></i>
                      <h5>设备列表 （选择型号后，如果勾选设备，仅修改所选设备的备案版本）</h5>
                    </div>
                    <div class="box-content">
                      <table id="dataTables-records" class="table table-striped table-hover table-bordered tablesorter">
                        <thead>
                          <tr>
                            <th><input type="checkbox" id="checkAll"></th>
                            <th>序号</th>
                            <th>用户编号</th>
                            <th>型号</th>
                            <th>连接类型</th>
                            <th>序列号</th>
                            <th>当前版本</th>
                            <th>备案版本</th>
                            <th>修改备案版本</th>
                            <th>操作</th>
                          </tr>
                        </thead>
                        <tbody id="session-list">
                        </tbody>
                      </table>
                    </div>
                  </div>
               </div>
              </div>
          </form>
        </section>
      </div>
    </div>
    {{> footer}}
    <script src="../js-plugins/jquery/jquery.dataTables.min.js"></script>
    <script type="text/javascript">
     $(function(){
         /* var lengthMenu =  '显示 ' + 
          *                   '<select class="form-control input-small">' +
          *                   '<option value="50">50</option>' + 
          *                   '<option value="100">100</option>' + 
          *                   '<option value="500">500</option>' + 
          *                   '<option value="1000">1000</option>' + 
          *                   '</select> 条记录';*/

         var options = {
             ajax: {
                 url: "/api/get-session-ver?model=all",
                 type: "GET"
             },
             columns: [
                 {
                     data   : null,
                     render : function (data) {
                         return '<input type="checkbox"  name="checkchild"  value="' + data.sn + '" />';
                     }
                 },
                 { data : "order" },
                 { data : "acct"  },
                 { data : "model" },
                 { data : "netif" },
                 { data : "sn" },
                 { data : "cur_ver" },
                 { data : "update_ver" },
                 {
                     data : null,
                     render: function () {
                         return '<input type="text" name="custom-ver" style="width:150px" />';
                     }
                 },
                 {
                     data : null,
                     render: function (data) {
                         return '<a class="set-single-update" href="#">提交</a>';
                     }
                 }
             ],

             paging:    true,
             ordering:  false,
             searching: true,
             lengthMenu: [50, 100, 500, 1000],
             language: {
                 sProcessing: "<img src='/images/datatable_loading.gif'>  努力加载数据中.",
                 lengthMenu: "每页显示_MENU_条记录",
                 search: '<span>条件搜索：</span>',
                 paginate: {        
                     previous : "上一页",
                     next     : "下一页",
                     first    : "<<<",
                     last     : ">>>"
                 },

                 info: "总共_PAGES_ 页，显示第_START_ 到第 _END_ ，筛选之后得到 _TOTAL_ 条，初始_MAX_ 条 ",
                 infoEmpty: "0条记录",
                 sZeroRecords: "没有数据",
                 infoFiltered: "(从 _MAX_ 条数据中检索)"
             },
             paging: true,
             pagingType: "full_numbers"       //分页样式的类型
         };

         var dataTable = $('#dataTables-records').dataTable(options);

         function render_session_model() {
             $.getJSON("/api/get-session-models")
              .done(function (data) {
                  $("#session-models").empty();
                  var option = '<option value="all">--请选择型号-- </option>';
                  $("#session-models").append(option);
                  for (var i = 0; i < data.length; i ++) {
                      var option = '<option value=' + data[i] + '>' + data[i] + '</option>';
                      $("#session-models").append(option);
                  }
              });

             return;
         }

         render_session_model();

         $("#session-models").change(function () {
             var model = $("#session-models").val();
             options.ajax.url = "/api/get-session-ver?model=" + model;
             options.destroy = true;
             dataTable = $('#dataTables-records').dataTable(options);
         });
         
         $("#checkAll").click(function () {
             if($(this).prop("checked")) {
                 $("input[name='checkchild']").attr("checked", "true");  
             } else {
                 $("input[name='checkchild']").removeAttr("checked");
             }  
         });

         function set_model_update_ver(model, ver, tids) {
             //console.log(model, ver, tids);
             var url = "/api/set-update-ver?model=" + model + "&ver=" + ver + "&tids=" + tids.join(";");

             var ajax = $.ajax({
                 url      : url,
                 type     : "GET",
                 timeout  : 5000,        //超时时间设置，单位毫秒
                 async    : false,
                 dataType :'json',       //返回的数据格式
                 success  : function (data) {
                     if (data.result == "OK") {
                         //window.onbeforeunload = null;
                         alert("提交成功，设备同步备案版本时间为一个小时左右。");
                         render_session_model();
                         $("#checkAll").removeAttr("checked");
                         options.ajax.url = "/api/get-session-ver?&model=all";
                         options.destroy = true;
                         $('#dataTables-records').dataTable(options);
                         return false;
                     } else {
                         alert("提交失败: " + JSON.stringify(data.result));
                         return false;
                     }
                 },
                 error    : function (data) {
                     alert("系统出错,请重新操作.", data);
                     return false;
                 },
                 complete : function (XMLHttpRequest,status) { //请求完成后最终执行参数
                     if (status === 'timeout') { //超时,status还有success,error等值
                         ajax.abort();
                         alert("请求超时,设置失败");
                     }
                 }
             });

             return false;
         }

         function isValidVer(ver) {
             if (!ver || ver.trim().length === 0) {
                 return false;
             }
             var arr = ver.split(".");
             if (arr.length !== 4) {
                 return false;
             }
             for (var i = 0; i < arr.length; i ++) {
                 if (isNaN(arr[i])) {
                     console.log(isNaN(arr[i]), i);
                     return false;
                 }
                 arr[i] = parseInt(arr[i], 10);
             }

             if (arr[2] !== 0 || arr[3] !== 0) {
                 return false;
             }

             return true;
         }

         $("#set-batch-update").click(function () {
             var tids = [];
             $("input[name='checkchild']:checkbox:checked").each(function () {
                 var tid = $(this).val();
                 if (tid !== "null") {
                     tids.push(tid);
                 }
             });

             var model = $("#session-models").val();
             var ver   = $("input[name=ver]").val();

             if (model.indexOf("CN") < 0) {
                 alert("请选择型号!");
                 return false;
             }
             if (!isValidVer(ver)) {
                 alert("版本号填写错误! 格式: xx.xx.0.0");
                 return false;
             }

             //没有选择就默认设置所有
             if (tids.length === 0) {
                 var res = confirm("升级所有型号为" +  model + "的设备版本为:" + ver);
                 if (false === res) {
                     return;
                 }
                 $("input[name='checkchild']").not("input:checked").each(function () {
                     var tid = $(this).val();
                     if (tid !== "null") {
                         tids.push(tid);
                     }
                 });
             }

             set_model_update_ver(model, ver, tids);

             return false;
         });

         $("body").on('click', ".set-single-update",function () {
             var children = $(this).parents("tr").children();
             var model    = children.eq(3).text();
             var tid      = children.eq(5).text();
             var ver      = children.find("input[name=custom-ver]").val();
             
             //console.log(model, tid, ver);
             if (model === 'n/a') {
                 alert("设备型号无效! " + model);
                 return false;
             }

             if (!isValidVer(ver)) {
                 alert("版本号填写错误! 格式: xx.xx.0.0");
                 return false;
             }

             var tids = [tid];
             set_model_update_ver(model, ver, tids);

             return false;
         });
     });

    </script>
  </body>
</html>
