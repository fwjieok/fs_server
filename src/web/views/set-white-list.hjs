<!DOCTYPE html>
<html lang="en">
  {{> header}}
  <link href="../css/file-import.css" rel="stylesheet">
  <body>
    {{> page_header}}
    <div id="body-container">
      <div id="body-content">
        {{> nav}}
        <section class="page container">
          <form class="form-horizontal" id="uploadForm">
            <div class="container">
              <div class="row">
                <div class="span8">
                  <fieldset>
                    <legend>批量添加
                      <!-- <span>(导入文件，<a href="/api/download-import-templete" >导入模板下载</a>)</span> -->
                      <span>(
                        <a href="/上传文件模板.csv" >上传文件模板下载</a>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <a href="/api/export-session-online" >导出在线列表设备</a>
                        )</span>
                    </legend>
                    <input type="file" name="import-list" />
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id="upload" class="btn btn-info">上传</button>
                  </fieldset>
                </div>
                <div class="span8">
                  <fieldset>
                    <legend>单个设备添加</legend><!-- <br/> -->
                      <span>TID<span>:
                        <input type="text" name="tid" value=""/>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <a id="set-white" class="btn btn-primary">添加</a>
                  </fieldset>
                </div>
              </div>            
              <br/>
              <div class="row">
                <div class="span16">
                  <div class="box pattern pattern-sandstone">
                    <div class="box-header">
                      <i class="icon-table"></i>
                      <h5>白名单列表</h5>
                    </div>
                    <div class="box-content">
                      <table id="dataTables-records" class="table table-striped table-hover table-bordered tablesorter">
                        <thead>
                          <tr>
                            <th>序号</th>
                            <th>型号</th>
                            <th>序列号</th>
                            <th>在线状态</th>
                            <th>操作</th>
                          </tr>
                        </thead>
                        <tbody id="session-list">
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
          </form>
        </section>
            </div>
      </div>
      {{> footer}}
      <script src="../js-plugins/jquery/jquery.dataTables.min.js"></script>
      <script type="text/javascript">
       $(function(){
           var options = {
               ajax: {
                   url: "/api/get-white-list",
                   type: "GET"
               },
               columns: [
                   { data : 0 },
                   { data : 1 },
                   { data : 2 },
                   {
                       data : null,
                       render: function (data) {
                           if (data[3]) {
                               return '<span style="color:green">在线</span>';
                           } else {
                               return '';
                           }
                       }
                   },
                   {
                       data : null,
                       render: function (data) {
                           return '<a class="remove-white-list" href="#">移除</a>';
                       }
                   }
               ],
               paging:    true,
               ordering:  false,
               searching: true,
               lengthMenu: [50, 100, 500, 1000],
               language: {
                   sProcessing: "<img src='/images/datatable_loading.gif'>  努力加载数据中.",
                   lengthMenu: "每页显示_MENU_条记录",
                   search: '<span>条件搜索：</span>',
                   paginate: {        
                       previous : "上一页",
                       next     : "下一页",
                       first    : "<<<",
                       last     : ">>>"
                   },

                   info: "总共_PAGES_ 页，显示第_START_ 到第 _END_ ，筛选之后得到 _TOTAL_ 条，初始_MAX_ 条 ",
                   infoEmpty: "0条记录",
                   sZeroRecords: "没有数据",
                   infoFiltered: "(从 _MAX_ 条数据中检索)"
               },
               paging: true,
               pagingType: "full_numbers"       //分页样式的类型
           };

           var dataTable = $('#dataTables-records').dataTable(options);

           //白名单文件上传
           $("#upload").click(function () {
               var formData = new FormData($('#uploadForm')[0]);
               var ajax = $.ajax({
                   type: 'post',
                   url: "/api/import-white-list",
                   data: formData,
                   timeout: 5000,
                   cache: false,
                   contentType: false,  //禁止设置请求类型
                   processData: false,  //禁止jquery对Data数据的处理,默认会处理
                   //禁止的原因是,FormData已经帮我们做了处理
                   success: function (data) {
                       alert(data.msg);
                       if (data.result == "OK") {
                           options.destroy = true;
                           $('#dataTables-records').dataTable(options);
                       }
                   },
                   error: function (error) {
                       alert("操作失败");
                       console.log(error);
                   },
                   complete: function (XMLHttpRequest,status) {
                       if(status=='timeout') {
                           ajax.abort();
                           alert("请求超时，服务器无响应，请稍后再试！");
                       }
                   }
               });

               return false;
           });

           function single_tid_operation(type, tid) {
               var url  = "/api/set-white-list?type=" + type + "&tid=" + tid;
               var ajax = $.ajax({
                   type: 'get',
                   url: url,
                   timeout: 3000
               }).success(function (data) {
                   alert(data.msg);
                   if (data.result == "OK") {
                       options.destroy = true;
                       $('#dataTables-records').dataTable(options);
                   }
               }).error(function (error) {
                   alert("操作失败");
                   console.log(error);
               }).complete(function (XMLHttpRequest,status) {
                   if(status=='timeout') {
                       ajax.abort();
                       alert("请求超时，服务器无响应，请稍后再试！");
                   }
               });
           }

           //单个白名单设置
           $("#set-white").click(function () {
               var tid = $("input[name=tid]").val().trim();
               single_tid_operation("set", tid);

               return false;
           });

           $("body").on('click', ".remove-white-list",function () {
               var children = $(this).parents("tr").children();
               var tid      = children.eq(2).text();

               single_tid_operation("unset", tid);

               return false;
           });

       });

      </script>
  </body>
</html>
