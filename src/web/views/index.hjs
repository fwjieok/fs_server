<!DOCTYPE html>
<html lang="en">
  {{> header}}
  <header>
    <style>
    </style>
  </header>
  <body>
    {{> page_header}}
    <div id="body-container">
      <div id="body-content">
        {{> nav }}
	    <section class="container">
          <br/>
          <div class="row">
            <div class="span4">
              <div class="box pattern pattern-sandstone">
                <div class="box-header">
                  <i class="icon-list"></i>
                  <h5>服务器状态</h5>
                </div>
                <div class="box-content box-table">
                  <table class="table table-striped table-hover table-bordered tablesorter">
                    <tbody>
                      <tr ><td>刷新倒计时</td><td><span id="update-counter"> 0 </span></td></tr>
                      <tr><td>设备运行时间</td><td><span id="sys-uptime"> 未知 </span></td></tr>
                      <tr><td>设备当前时间</td><td><span id="sys-time"> 未知 </span></td></tr>
                      <tr><td>设备型号</td><td><span id="sys-model">  </span></td></tr>
                      <tr><td>设备ID</td><td><span id="sys-sn"> 未知 </span></td></tr>
                      <tr><td>固件版本</td><td><span id="sys-version"> 未知 </span></td></tr>
                      <tr><td>网络状态</td><td><span id="sys-network"> 未知 </span></td></tr>
                      <tr><td>互联网状态</td><td><span id="sys-internet"> 未知 </span></td></tr>

		              <tr><td>警云状态</td><td><span id="things-server"> 未知 </span></td></tr>
                      <tr><td>正在推流设备数</td><td><span id="total-online"> 未知 </span></td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="span12">
	          <div class="box pattern pattern-sandstone">
                <div class="box-header">
                  <i class="icon-table"></i>
                  <h5>存储设备列表</h5>
                </div>
	          </div>
              <div class="box-content box-table">
                <table class="table table-striped table-hover table-bordered tablesorter">
                  <thead>
                    <tr>
					  <th class="center span1">编号</th>
                      <th class="center span2">名称</th>
                      <th class="center span2">主机名或IP</th>
                      <th class="center span1">端口</th>
					  <th class="center span2">总容量</th>
                      <th class="center span2">剩余容量</th>
                      <th class="center span2">状态</th>
                    </tr>
                  </thead>
                  <tbody id="storage-list">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
	    </section>
	  </div>
    </div>
   
    <div id="spinner" class="spinner" style="display:none;">
      Loading&hellip;
    </div>
    {{> footer}}

    <script src="../js-plugins/jquery/jquery-tablesorter.js" type="text/javascript" ></script>
    <script src="../js-plugins/jquery/jquery-chosen.js" type="text/javascript" ></script>   
    <script src="../layer/layer.js"></script>
    
    <script type="text/javascript">

     $(document).ready(function () {
         $('#session-list').tablesorter();
         $(".chosen").chosen();
         var runtime = {};

         function update_display() {
             $("#sys-uptime").html(runtime["sys-uptime"]).css("color", "green");
             $("#sys-time").html(runtime["sys-time"]).css("color", "green");
             $("#sys-model").html(runtime["sys-model"]).css("color", "green");
             $("#sys-sn").html(runtime["sys-sn"]).css("color", "green");
             $("#sys-version").html(runtime["sys-version"]).css("color", "green");
             $("#sys-os").html(runtime["sys-os"]).css("color", "green");

             var statusStrs = ["正常","未启用","故障"];    
    
             if (runtime["sys-network-fail"]) {
                 $("#sys-network").html("故障").css("color", "red");
             } else {
                 $("#sys-network").html("正常").css("color", "green");
             }
             $("#total-online").html(runtime["total-online"]).css("color", "green");
             
         };
         
         function update_data() {
             $.getJSON("/api/get-server-status")
              .error(function (error) {
                  location.reload();
              })
              .done(function (json) {
                  runtime = json;
                  update_display();
                  start_next_update();
                  update_cnt = 5;
              });

             $.getJSON("/api/get-storage", function (json) {
                 settings = json.storage;
                 var list = $("#storage-list");
                 list.empty();
                 var index = 1;
                 for (var key in json.storage) {
                     if (!json.storage.hasOwnProperty(key)) { continue; };
                     var storage = settings[key];
                     append_line(index ++, key, storage);
                 }
                 return;
             });
         };
         var update_cnt = 5;
         function start_next_update() {
             $("#update-counter").text(update_cnt);
             update_cnt--;
             if (update_cnt === 0) {
                 update_data();
             } else {
                 setTimeout(start_next_update, 1000);
             }
         }
         update_data();

         function append_line(index, key, storage) {
             var list = $("#storage-list");
             var row = $("<tr>").attr("id", "row-" + key);

             $("<td>").appendTo(row).append(index).css("color", "green");

             $("<td>").attr("id", "col-key")
                      .addClass("center")
                      .append(key)
                      .appendTo(row);

             $("<td>").appendTo(row).append(storage.hostname);
             $("<td>").appendTo(row).append(storage.port);
             $("<td>").appendTo(row).append(storage.size_total);
             $("<td>").appendTo(row).append(storage.size_free);
             if (storage.enabled) {
                 $("<td>").appendTo(row).append("已启用").css("color", "green");
             } else {
                 $("<td>").appendTo(row).append("未启用").css("color", "red");
             }
             
             row.appendTo(list);
         };
         settings = {};

     });
    </script>
  </body>
</html>
