<!DOCTYPE html>
<html lang="en">
  {{> header}}
  <header>
    <style>
    </style>
  </header>
  <body>
    {{> page_header}}
    <div id="body-container">
      <div id="body-content">
        {{> nav }}
	    <section class="container">
          <div class="row">
            <div class="span4">
              <div class="box pattern pattern-sandstone">
                <div class="box-header">
                  <i class="icon-list"></i>
                  <h5>服务器状态</h5>
                </div>
                <div class="box-content box-table">
                  <table class="table table-striped table-hover table-bordered tablesorter">
                    <tbody>
                      <tr ><td>刷新倒计时</td><td><span id="update-counter"> 0 </span></td></tr>
                      <tr><td>设备运行时间</td><td><span id="sys-uptime"> 未知 </span></td></tr>
                      <tr><td>设备当前时间</td><td><span id="sys-time"> 未知 </span></td></tr>
                      <tr><td>设备型号</td><td><span id="sys-model">  </span></td></tr>
                      <tr><td>接入数量</td><td><span id="sys-connections"> 无  </span></td></tr>
                      <tr><td>设备ID</td><td><span id="sys-sn"> 未知 </span></td></tr>
                      <tr><td>固件版本</td><td><span id="sys-version"> 未知 </span></td></tr>
                      <tr><td>网络状态</td><td><span id="sys-network"> 未知 </span></td></tr>
                      <tr><td>互联网状态</td><td><span id="sys-internet"> 未知 </span></td></tr>

		              <tr><td>警云服务器</td><td><span id="things-server"> 未知 </span></td></tr>
                      <tr><td>正在推流设备数</td><td><span id="total-online"> 未知 </span></td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="span12">
	          <div class="box pattern pattern-sandstone">
                <div class="box-header">
                  <i class="icon-table"></i>
                  <h5>存储设备列表</h5>
                </div>
	          </div>
              <div class="box-content box-table">
                <table class="table table-striped table-hover table-bordered tablesorter">
                  <thead>
                    <tr>
					  <th class="center span1">编号</th>
                      <th class="center span2">是否启用</th>
                      <th class="center span2">名称</th>
                      <th class="center span2">主机名或IP</th>
                      <th class="center span1">端口</th>
                      <th class="center span2">协议</th>
					  <th class="center span2">总容量</th>
                      <th class="center span2">剩余容量</th>
                    </tr>
                  </thead>
                  <tbody id="lines-list">
                  </tbody>
                </table>
              </div>
            </div>

          </div>
	    </section>
	  </div>
    </div>
   
    <div id="spinner" class="spinner" style="display:none;">
      Loading&hellip;
    </div>
    {{> footer}}

    <script src="../js-plugins/jquery/jquery-tablesorter.js" type="text/javascript" ></script>
    <script src="../js-plugins/jquery/jquery-chosen.js" type="text/javascript" ></script>
    <!-- <script src="../js-plugins/bootstrap/bootstrap-contextmenu.js" type="text/javascript" ></script> -->
    
    <script src="../js-user/remote-program.js" type="text/javascript" ></script>
    <script src="../js-user/remote-control.js" type="text/javascript" ></script>
    <script src="../layer/layer.js"></script>
    
    <script type="text/javascript">

     $(document).ready(function () {
         $('#session-list').tablesorter();
         $(".chosen").chosen();
         var runtime = {};

         function update_display() {
             $("#sys-uptime").html(runtime["sys-uptime"]).css("color", "green");
             $("#sys-time").html(runtime["sys-time"]).css("color", "green");
             $("#sys-model").html(runtime["sys-model"]).css("color", "green");
             $("#sys-sn").html(runtime["sys-sn"]).css("color", "green");
             $("#module-cn0801-tid").html(runtime["module-cn0801-tid"]).css("color", "green");
             $("#sys-version").html(runtime["sys-version"]).css("color", "green");
             $("#sys-os").html(runtime["sys-os"]).css("color", "green");
             $("#sys-modules").html(runtime["sys-modules"]).css("color", "green");
             $("#sys-lines").html(runtime["sys-lines"]).css("color", "green");
             $("#sys-connections").html(runtime["sys-connections"]).css("color", "green");

             var statusStrs = ["正常","未启用","故障"];
             
             var text  = "(" + runtime["serial-pending-event"]
                       + "/"+ runtime["serial-pending-status"]
                       + "/"+ runtime["event-log-length"] + ")";

             var statusCode = runtime["sys-channel-serial-status"];
             $("#sys-channel-serial-status").html(statusStrs[statusCode] + text);
             if (statusCode > 0) {
                 $("#sys-channel-serial-status").css("color", "red");
             } else {
                 $("#sys-channel-serial-status").css("color", "green");
             }

             var text  = "(" + runtime["tcp-pending-event"]
                       + "/"+ runtime["tcp-pending-status"]
                       + "/"+ runtime["event-log-length"] + ")";
             var statusCode   = runtime["sys-channel-tcp-status"];
             $("#sys-channel-tcp-status").html(statusStrs[statusCode] + text);
             if (statusCode > 0) {
                 $("#sys-channel-tcp-status").css("color", "red");
             } else {
                 $("#sys-channel-tcp-status").css("color", "green");
             }

             if (runtime["sys-network-fail"]) {
                 $("#sys-network").html("故障").css("color", "red");
             } else {
                 $("#sys-network").html("正常").css("color", "green");
             }
             $("#total-online").html(runtime["total-online"]).css("color", "green");
             
         };
         
         function update_data() {
             $.getJSON("/api/get-server-status")
              .error(function (error) {
                  location.reload();
              })
              .done(function (json) {
                  runtime = json;
                  update_display();
                  start_next_update();
                  update_cnt = 5;
              });
             $.getJSON("/api/get-lines", function (json) {
                 settings = json.lines;
                 var list = $("#lines-list");
                 list.empty();
                 for (var key in settings) {
                     if (!settings.hasOwnProperty(key)) { continue; };
                     var line = settings[key];
                     append_line(key, line);
                 }
                 return;
             });
         };
         var update_cnt = 5;
         function start_next_update() {
             $("#update-counter").text(update_cnt);
             update_cnt--;
             if (update_cnt === 0) {
                 update_data();
             } else {
                 setTimeout(start_next_update, 1000);
             }
         }
         update_data();

         function append_line(key, line) {
             var list = $("#lines-list");
             var row = $("<tr>").attr("id", "row-" + key);
             if (line.enabled) {
                 $("<td>").appendTo(row).append("已启用").css("color", "green");
             } else {
                 $("<td>").appendTo(row).append("未启用").css("color", "red");
             }

             $("<td>").attr("id", "col-key")
                      .addClass("center")
                      .append(key)
                      .appendTo(row);

             $("<td>").appendTo(row).append(line.name);
             $("<td>").appendTo(row).append(line.prefix);
             $("<td>").appendTo(row).append(line.port);
             $("<td>").appendTo(row).append(line.protocol);
             $("<td>").appendTo(row).append(line.online);
             row.appendTo(list);
         };
         settings = {};

     });
    </script>
  </body>
</html>
